<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toro R√°pido - Pedidos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="pedidos.css">
    <link rel="stylesheet" href="footer.css">
</head>
<body>

<div id="overlay-carga">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--whatsapp-color);"></i>
    <p style="margin-top:15px; font-weight:700;">Procesando pedido...</p>
</div>

<div class="contenedor">
    <div class="resumen-menu" id="resumen-menu" style="display:none;">
        <div class="resumen-menu-title">Resumen del pedido realizado</div>
        <div id="resumen-menu-items"></div>
        <div class="resumen-menu-row">
            <span>Subtotal</span>
            <strong id="resumen-menu-subtotal">$ 0</strong>
        </div>
        <div class="resumen-menu-row">
            <span>Env√≠o</span>
            <strong id="resumen-menu-envio">$ 0</strong>
        </div>
        <div class="resumen-menu-total">
            <span>Total</span>
            <strong id="resumen-menu-total">$ 0</strong>
        </div>
        <div class="resumen-menu-note">Revis√° tu pedido antes de enviarlo por WhatsApp.</div>
    </div>

    <div class="resumen-caja" id="caja-resumen">
        <div style="font-weight: 800; margin-bottom: 15px; color: var(--azul-oscuro); text-align: center; text-transform: uppercase;">Resumen de Pedido</div>
        <div id="lista-resumen"></div>
        
        <div class="fila-resumen" id="fila-envio" style="border-bottom: none; color: #166534;">
            <span>Gastos de Env√≠o</span>
            <strong id="monto-envio">$ 0</strong>
        </div>

        <div class="total-badge">
            <span style="font-weight:700;">TOTAL ESTIMADO</span>
            <span id="monto-total-display" style="font-weight:900; color:var(--rojo-toro); font-size:1.4em;">$ 0</span>
        </div>
        <div class="zona-aviso">
            ‚ö†Ô∏è Una vez recibido el pedido, analizaremos tu domicilio para confirmar si contamos con entregas en tu zona.
        </div>
    </div>

    <div class="datos-cliente">
        <div style="font-weight: 800; color: #166534; margin-bottom: 15px; font-size: 1em; text-align: center;">üìç DATOS DE ENTREGA</div>
        
        <div class="input-group">
            <label>Nombre de quien recibe:</label>
            <i class="fa-solid fa-user"></i>
            <input type="text" id="cust-name" class="input-field" placeholder="Ej: Juan P√©rez">
        </div>

        <div class="input-group">
            <label>WhatsApp:</label>
            <i class="fa-solid fa-phone"></i>
            <input type="tel" id="cust-phone" class="input-field" placeholder="Ej: 3814556677">
        </div>

        <div class="input-group">
            <label>Domicilio:</label>
            <i class="fa-solid fa-location-dot"></i>
            <input type="text" id="cust-address" class="input-field" placeholder="Calle, n√∫mero, barrio...">
        </div>
    </div>

    <button onclick="enviarPedido()" class="boton-pedido">
        <i class="fa-brands fa-whatsapp fa-xl"></i> ENVIAR POR WHATSAPP
    </button>
    <a href="confirmacion.html" class="boton-confirmacion">
        <i class="fa-solid fa-circle-check fa-lg"></i> CONFIRMAR PEDIDO
    </a>

    <div id="site-footer"></div>
</div>

<script>
    const TELEFONO_NEGOCIO = "5493814130520"; 
    const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycby5-AAAxjPm68aNc6hQ0zk6prVUoGe5TAlWUCbzq3eKHW8_mkZneSZ0GM8Tb5sOExs_/exec";

    const COSTO_ENVIO_BASE = 1500; 
    const MINIMO_ENVIO_GRATIS = 25000;

    function formatearMoneda(valor) { return `$ ${Number(valor).toLocaleString('es-AR')}`; }


    async function enviarPedido() {
        const n = document.getElementById('cust-name').value.trim();
        const w = document.getElementById('cust-phone').value.trim();
        const d = document.getElementById('cust-address').value.trim();
        if(!n || !d || !w) { alert("‚ö†Ô∏è Por favor, completa tus datos de entrega."); return; }

        let productosParaSheet = [];
        let itemsWhatsApp = ""; 
        let subtotal = 0;

        document.querySelectorAll('.qty-num').forEach(el => {
            const cant = parseInt(el.innerText);
            if(cant > 0) {
                const precio = parseFloat(el.dataset.precio);
                const itemSub = cant * precio;
                subtotal += itemSub;
                const prefijoWA = el.dataset.promo === "true" ? "[PROMO] " : "";
                itemsWhatsApp += `- (x${cant}) ${prefijoWA}${el.dataset.nombre} ${formatearMoneda(itemSub)}\n`;
                
                productosParaSheet.push({
                    categoria: el.dataset.cat,
                    idproducto: el.dataset.idreal, 
                    producto: el.dataset.nombre,
                    precio: precio,
                    cantidad: cant,
                    subtotal: itemSub
                });
            }
        });

        if(subtotal === 0) { alert("‚ùå Selecciona productos antes de enviar."); return; }

        document.getElementById('overlay-carga').style.display = 'flex';
        const costoEnvio = subtotal >= MINIMO_ENVIO_GRATIS ? 0 : COSTO_ENVIO_BASE;
        const ahora = new Date();
        const idPedido = "PED-" + ahora.getTime();

        try {
            await fetch(URL_APPS_SCRIPT, {
                method: "POST",
                mode: "no-cors", 
                body: JSON.stringify({
                    idpedido: idPedido,
                    fecha: ahora.toLocaleDateString('es-AR'),
                    hora: ahora.toLocaleTimeString('es-AR'),
                    cliente: n, whatsapp: w, direccion: d,
                    total: subtotal + costoEnvio,
                    productos: productosParaSheet
                })
            });
        } catch (e) { console.error(e); }

        let msg = `*TORO R√ÅPIDO - NUEVO PEDIDO*\n_ID: ${idPedido}_\n\n*CLIENTE:* ${n}\n*DIR:* ${d}\n*TEL:* ${w}\n\n*DETALLE:*\n${itemsWhatsApp}`;
        msg += `\n*SUBTOTAL:* ${formatearMoneda(subtotal)}`;
        msg += `\n*ENV√çO:* ${costoEnvio === 0 ? "¬°GRATIS!" : formatearMoneda(costoEnvio)}`;
        msg += `\n*TOTAL:* ${formatearMoneda(subtotal + costoEnvio)}\n\n_‚ö†Ô∏è Sujeto a confirmaci√≥n de zona._`;

        document.getElementById('overlay-carga').style.display = 'none';
        window.open(`https://wa.me/${TELEFONO_NEGOCIO}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function leerPedidoMenu() {
        const params = new URLSearchParams(window.location.search);
        let payload = null;
        const raw = params.get("pedido");
        if (raw) {
            try {
                payload = JSON.parse(decodeURIComponent(raw));
            } catch (e) {
                console.error(e);
            }
        }
        if (!payload) {
            try {
                const stored = sessionStorage.getItem("toro_pedido");
                if (stored) payload = JSON.parse(stored);
            } catch (e) {
                console.error(e);
            }
        }
        return payload;
    }

    function renderResumenMenu() {
        const container = document.getElementById("resumen-menu");
        const list = document.getElementById("resumen-menu-items");
        const subtotalEl = document.getElementById("resumen-menu-subtotal");
        const envioEl = document.getElementById("resumen-menu-envio");
        const totalEl = document.getElementById("resumen-menu-total");
        if (!container || !list || !subtotalEl || !envioEl || !totalEl) return;

        const payload = leerPedidoMenu();
        if (!payload || !Array.isArray(payload.items) || payload.items.length === 0) return;

        list.innerHTML = payload.items.map((item) => `
            <div class="resumen-menu-item">
                <span>${item.qty}x ${item.name}</span>
                <strong>${formatearMoneda(item.subtotal)}</strong>
            </div>
        `).join("");

        subtotalEl.innerText = formatearMoneda(payload.subtotal || 0);
        if ((payload.subtotal || 0) > 0 && (payload.delivery || 0) === 0) {
            envioEl.innerText = "¬°GRATIS!";
        } else {
            envioEl.innerText = formatearMoneda(payload.delivery || 0);
        }
        totalEl.innerText = formatearMoneda(payload.total || 0);
        container.style.display = "block";
    }

    function initPedidos() {
        renderResumenMenu();
    }

    async function cargarPie() {
        const container = document.getElementById("site-footer");
        if (!container) return;
        try {
            const response = await fetch("footer.html");
            if (!response.ok) return;
            container.innerHTML = await response.text();
        } catch (e) {
            console.error(e);
        }
    }

    async function initPedidos() {
        renderResumenMenu();
        await cargarPie();
    }

    window.onload = initPedidos;
</script>
</body>
</html>
